{% extends 'core/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Membership - ESA{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1522202176988-66273c2fd55f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2071&q=80');">
  <div class="bg-black bg-opacity-50">
    <div class="container mx-auto px-4 py-24">
      <div class="flex flex-wrap md:flex-nowrap items-center">
        <div class="w-full md:w-1/2 mb-8 md:mb-0 text-white">
          <h1 class="text-4xl font-bold mb-4">Join the ESA-KU Community</h1>
          <p class="text-lg mb-4">Access exclusive resources, attend special events, and connect with fellow engineering students and professionals.</p>
          <p class="mb-4">
            {% if is_member %}
              <span class="bg-green-600 text-white px-3 py-1 rounded-full inline-flex items-center">
                <i class="fas fa-check-circle mr-2"></i>You're already a member!
              </span>
            {% else %}
              <span class="bg-yellow-500 text-white px-3 py-1 rounded-full inline-flex items-center">
                <i class="fas fa-info-circle mr-2"></i>Not a member yet
              </span>
            {% endif %}
          </p>
        </div>
        <!--
        <div class="w-full md:w-1/2">
          <img src="{% static 'images/membership_hero.png' %}" alt="ESA Membership" class="rounded-lg shadow-lg w-full">
        </div>
        -->
      </div>
    </div>
  </div>
</section>

<!-- Benefits Section -->
<section class="py-12 bg-gray-100">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-10">Membership Benefits</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-book-open text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Exclusive Resources</h3>
                <p class="text-gray-700 mb-4">
                    Access to engineering research papers, study materials, and technical resources.
                </p>
                <a href="{% url 'resources' %}" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>Browse resources</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-users text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Networking</h3>
                <p class="text-gray-700 mb-4">
                    Connect with engineering professionals, academics, and fellow students in the field.
                </p>
                <a href="{% url 'communities' %}" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>Join communities</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-calendar-check text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Priority Event Access</h3>
                <p class="text-gray-700 mb-4">
                    Early registration and discounts for workshops, field trips, and engineering conferences.
                </p>
                <a href="{% url 'events' %}" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>Upcoming events</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-graduation-cap text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Learning Opportunities</h3>
                <p class="text-gray-700 mb-4">
                    Access to engineering workshops, training sessions, and technical educational content.
                </p>
                <a href="{% url 'resources' %}?category=document" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>Educational materials</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-certificate text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Certifications</h3>
                <p class="text-gray-700 mb-4">
                    Official member certificate and recognition in the engineering community.
                </p>
                <a href="{% url 'profile' %}" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>View your profile</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition text-center">
                <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-store text-3xl text-blue-900"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-900 mb-3">Store Discounts</h3>
                <p class="text-gray-700 mb-4">
                    Special discounts on ESA merchandise and engineering tools.
                </p>
                <a href="{% url 'store' %}" class="text-blue-700 hover:text-blue-900 inline-flex items-center font-medium">
                    <span>Shop now</span>
                    <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Member Resources & Opportunities Section -->
<section class="py-12 bg-white" id="membershipOpportunities" >
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-bold text-blue-900 text-center mb-10">Membership Opportunities</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Members' Own Stories -->
      <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
            <i class="fas fa-quote-right text-2xl text-blue-900"></i>
          </div>
          <h3 class="text-xl font-bold text-blue-900">Members' Own Stories</h3>
        </div>
        <p class="text-gray-700 mb-4">
          Show members and non-members alike what it means to be part of ESA. Your story can inspire others to join our community and make the most of their engineering education.
        </p>
        <a href="{% url 'blog_post_create' %}" class="text-green-700 font-semibold hover:underline flex items-center">
          <span>Share your ESA story</span>
          <i class="fas fa-arrow-right ml-2"></i>
        </a>
      </div>
        
      <!-- Gift of Membership -->
      <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
            <i class="fas fa-gift text-2xl text-blue-900"></i>
          </div>
          <h3 class="text-xl font-bold text-blue-900">Gift of Membership</h3>
        </div>
        <p class="text-gray-700 mb-4">
          ESA membership is a great gift idea and a way to share in the experience of being a member of ESA. Support a friend's engineering journey with this meaningful present.
        </p>
        <a href="{% url 'member_get_member' %}" class="text-green-700 font-semibold hover:underline flex items-center">
          <span>Give the gift of membership</span>
          <i class="fas fa-arrow-right ml-2"></i>
        </a>
      </div>
      
      <!-- Member-Get-a-Member -->
      <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
            <i class="fas fa-user-plus text-2xl text-blue-900"></i>
          </div>
          <h3 class="text-xl font-bold text-blue-900">Member-Get-a-Member</h3>
        </div>
        <p class="text-gray-700 mb-4">
          Help grow our engineering community by sponsoring someone's membership. You can pay for a friend, colleague, or someone deserving to join ESA and enjoy all membership benefits.
        </p>
        <a href="{% url 'member_get_member' %}" class="text-green-700 font-semibold hover:underline flex items-center">
          <span>Pay for someone's membership</span>
          <i class="fas fa-arrow-right ml-2"></i>
        </a>
      </div>
      
      <!-- ESA Journals for Members -->
      <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
            <i class="fas fa-book-open text-2xl text-blue-900"></i>
          </div>
          <h3 class="text-xl font-bold text-blue-900 mb-3">ESA Journals for Members</h3>
    </div>
        <p class="text-gray-700 mb-4">
          More than 400 engineering students at Kenyatta University make ESA an integral part of their lives. Explore their innovations and experiences in our journals.
        </p>
        <a href="{% url 'esa_journals' %}" class="text-green-700 font-semibold hover:underline flex items-center">
          <span>View more videos and stories at ESA Journals</span>
          <i class="fas fa-arrow-right ml-2"></i>
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Pricing Plans Section -->
<section class="py-12" id="pricingSection">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-blue-900 text-center mb-2">Membership Plans</h2>
        <p class="text-xl text-center text-gray-600 mb-10">Choose the membership plan that best suits your needs</p>
        
        {% if is_member %}
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-10 text-center">
            <i class="fas fa-star mr-2"></i>
            <strong>You already have an active membership!</strong> Your membership is valid until your expiry date.
        </div>
        {% endif %}
        
        <div class="max-w-4xl mx-auto">
            <!-- Membership Tiers -->
            <div class="mb-12">
                <h2 class="text-3xl font-bold text-center mb-8">Choose Your Membership Tier</h2>
                
                <!-- Toggle Buttons -->
                <div class="flex justify-center space-x-4 mb-8">
                    <button id="studentToggle" class="px-6 py-2 rounded-lg bg-blue-900 text-white hover:bg-blue-800 transition-colors">
                        Student
                    </button>
                    <button id="graduateToggle" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                        Graduate/Professional
                    </button>
                </div>

                <!-- Student Tiers -->
                <div id="studentTiers" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- First Year Tier -->
                    <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-900">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">First Year Student</h3>
                        <p class="text-3xl font-bold mb-4">KSh 250</p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Access to all ESA-KU events
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Student resources
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Networking opportunities
                            </li>
                        </ul>
                        <button onclick="selectTier('first_year', 250)" class="w-full bg-blue-900 text-white py-2 rounded-lg hover:bg-blue-800 transition-colors">
                            Select Plan
                        </button>
                    </div>

                    <!-- Other Students Tier -->
                    <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-900">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Other Students</h3>
                        <p class="text-3xl font-bold mb-4">KSh 300</p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                All First Year benefits
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Priority event registration
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Access to workshops
                            </li>
                        </ul>
                        <button onclick="selectTier('other_students', 300)" class="w-full bg-blue-900 text-white py-2 rounded-lg hover:bg-blue-800 transition-colors">
                            Select Plan
                        </button>
                    </div>
                </div>

                <!-- Graduate/Professional Tiers -->
                <div id="graduateTiers" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                    <!-- Graduate Tier -->
                    <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-900">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Graduate/Professional</h3>
                        <p class="text-3xl font-bold mb-4">KSh 1,000</p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                All Student benefits
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Professional networking
                            </li>
                            <li class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Career development resources
                            </li>
                        </ul>
                        <button onclick="selectTier('graduate', 1000)" class="w-full bg-blue-900 text-white py-2 rounded-lg hover:bg-blue-800 transition-colors">
                            Select Plan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FAQ Section -->
<section class="py-12 bg-gray-100">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-blue-900 text-center mb-10">Frequently Asked Questions</h2>
        <div class="max-w-3xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow">
                <button class="flex justify-between items-center w-full p-6 text-left" onclick="toggleFAQ(this)">
                    <span class="font-bold text-blue-900">How do I know which membership plan is right for me?</span>
                    <i class="fas fa-chevron-down text-blue-900 transition-transform"></i>
                </button>
                <div class="hidden px-6 pb-6">
                    <p class="text-gray-700">
                        If you're a first-year student, the Basic plan is perfect to get started. Current students should choose the Standard plan for the best value, while graduates and professionals benefit most from the Premium plan with its advanced networking and collaboration opportunities.
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow">
                <button class="flex justify-between items-center w-full p-6 text-left" onclick="toggleFAQ(this)">
                    <span class="font-bold text-blue-900">How can I pay for membership?</span>
                    <i class="fas fa-chevron-down text-blue-900 transition-transform"></i>
                </button>
                <div class="hidden px-6 pb-6">
                    <p class="text-gray-700">
                        We accept M-Pesa for local payments and PayPal for international payments. Both methods are secure and transactions are processed immediately.
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow">
                <button class="flex justify-between items-center w-full p-6 text-left" onclick="toggleFAQ(this)">
                    <span class="font-bold text-blue-900">Can I upgrade my membership plan later?</span>
                    <i class="fas fa-chevron-down text-blue-900 transition-transform"></i>
                </button>
                <div class="hidden px-6 pb-6">
                    <p class="text-gray-700">
                        Yes! You can upgrade your membership at any time. The remaining value of your current membership will be credited toward your new plan.
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow">
                <button class="flex justify-between items-center w-full p-6 text-left" onclick="toggleFAQ(this)">
                    <span class="font-bold text-blue-900">How long does my membership last?</span>
                    <i class="fas fa-chevron-down text-blue-900 transition-transform"></i>
                </button>
                <div class="hidden px-6 pb-6">
                    <p class="text-gray-700">
                        Memberships are valid for the duration specified in your selected plan, typically 12 months. You'll receive renewal reminders before expiration.
                    </p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow">
                <button class="flex justify-between items-center w-full p-6 text-left" onclick="toggleFAQ(this)">
                    <span class="font-bold text-blue-900">What happens if I need to cancel my membership?</span>
                    <i class="fas fa-chevron-down text-blue-900 transition-transform"></i>
                </button>
                <div class="hidden px-6 pb-6">
                    <p class="text-gray-700">
                        While we don't offer refunds for membership fees, you can contact us at <a href="mailto:esa.kenyattauniv@gmail.com" class="text-blue-700 hover:underline">esa.kenyattauniv@gmail.com</a> if you have special circumstances.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Testimonials Section -->
<section class="py-12">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-blue-900 text-center mb-10">What Our Members Say</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-white rounded-xl shadow p-6 relative">
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2">
                    <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center text-white font-bold text-xl">
                        SK
                    </div>
                </div>
                <div class="pt-8">
                    <div class="flex text-yellow-400 mb-3 justify-center">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="italic text-gray-700 mb-4">
                        "Joining ESA was one of my best decisions at KU. I've made incredible connections and learned so much beyond the classroom."
                    </p>
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-900">Sarah Kimani</h4>
                            <p class="text-sm text-gray-600">3rd Year Student</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6 relative">
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2">
                    <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center text-white font-bold text-xl">
                        DO
                    </div>
                </div>
                <div class="pt-8">
                    <div class="flex text-yellow-400 mb-3 justify-center">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="italic text-gray-700 mb-4">
                        "As a graduate, ESA membership has opened doors to research opportunities and connected me with professionals in my field."
                    </p>
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-900">David Omondi</h4>
                            <p class="text-sm text-gray-600">KU Graduate 2022</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6 relative">
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2">
                    <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center text-white font-bold text-xl">
                        JM
                    </div>
                </div>
                <div class="pt-8">
                    <div class="flex text-yellow-400 mb-3 justify-center">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                    <p class="italic text-gray-700 mb-4">
                        "The resources available through ESA membership have been invaluable for my studies. The community is supportive and inspiring."
                    </p>
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-900">Jane Mutua</h4>
                            <p class="text-sm text-gray-600">2nd Year Student</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="py-12 bg-blue-900 text-white">
    <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold mb-4">Ready to join the ESA-KU community?</h2>
        <p class="max-w-2xl mx-auto mb-8 text-lg">
            Become a member today and unlock all the benefits!
        </p>
        <div class="flex flex-wrap justify-center gap-4">
            {% if is_member %}
                <button class="bg-white text-blue-900 cursor-not-allowed opacity-75 px-8 py-3 rounded-lg font-bold" disabled>Already a Member</button>
            {% elif not user.is_authenticated %}
                <a href="{% url 'register_with_payment' %}" class="bg-white text-blue-900 hover:bg-gray-100 px-8 py-3 rounded-lg font-bold transition">
                    Join Now
                </a>
            {% else %}
                <a href="#pricingSection" class="bg-white text-blue-900 hover:bg-gray-100 px-8 py-3 rounded-lg font-bold transition">
                    Join Now
                </a>
            {% endif %}
        </div>
  </div>
</section>
<!-- Payment Form -->
<div id="paymentForm" class="fixed inset-y-0 left-0 bg-white hidden w-96 shadow-2xl z-50 overflow-y-auto transform transition-transform duration-300 ease-in-out">
    <div class="p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-blue-900">Complete Membership</h2>
            <button onclick="document.getElementById('paymentForm').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="membershipForm" method="POST" action="" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="planType" name="plan_type">
            <input type="hidden" id="amount" name="amount">
            <input type="hidden" id="paymentMethod" name="payment_method">

            <!-- Personal Details Section -->
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" name="first_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" name="last_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <input type="email" name="email" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" name="phone_number" required placeholder="+254 7XX XXX XXX"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Payment Method Section -->
            <div class="border-t border-gray-200 pt-4">
                <h3 class="text-lg font-medium text-gray-900 mb-3">Payment Method</h3>
                <div class="flex gap-2 mb-4">
                    <button type="button" id="mpesaTab" onclick="togglePaymentMethod('mpesa')" 
                            class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-md hover:border-blue-500 transition-all">
                        <img src="{% static 'images/mpesa_logo.png' %}" alt="M-Pesa" class="h-11">
                    </button>
                    <button type="button" id="paypalTab" onclick="togglePaymentMethod('paypal')" 
                            class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-md hover:border-blue-500 transition-all">
                        <img src="{% static 'images/paypal_logo.png' %}" alt="PayPal" class="h-11">
                    </button>
                    <button type="button" id="cardTab" onclick="togglePaymentMethod('card')" 
                            class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-md hover:border-blue-500 transition-all">
                        <i class="fas fa-credit-card text-xl"></i>
                    </button>
                </div>

                <!-- M-Pesa Fields -->
                <div id="mpesaFields" class="transition-all duration-300">
                    <div class="bg-blue-50 p-4 rounded-md border border-blue-100">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-blue-900">Total Amount:</span>
                            <span id="totalAmount" class="text-lg font-bold text-blue-900">KSh 0</span>
                        </div>
                        <p class="text-sm text-blue-800 mb-4">
                            Click "Pay Now" to receive an M-Pesa payment request on your phone.
                        </p>
                    </div>

                    <!-- Payment Confirmation Dialog -->
                    <div id="paymentConfirmation" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">Payment Status</h3>
                            
                            <!-- Initial STK Message -->
                            <div id="stkMessage" class="mb-4">
                                <p class="text-gray-700">Please check your phone for the M-Pesa payment request.</p>
                                <p class="text-sm text-gray-500 mt-2">Enter your M-Pesa PIN to complete the payment.</p>
                            </div>

                            <!-- Alternative Payment Section -->
                            <div id="alternativePayment" class="border-t pt-4 mt-4">
                                <p class="text-sm text-gray-600 mb-3">If you didn't receive the payment request:</p>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        M-Pesa Transaction Code
                                    </label>
                                    <input type="text" id="mpesaCode" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                           placeholder="e.g., QWE1234567">
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3">
                                <button onclick="confirmPayment()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Confirm Payment
                                </button>
                                <button onclick="closePaymentDialog()" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PayPal Fields -->
                <div id="paypalFields" class="hidden">
                    <div class="bg-yellow-50 p-4 rounded-md border border-yellow-100">
                        <div class="flex items-center mb-2 text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="font-medium">Coming Soon</span>
                        </div>
                        <p class="text-sm text-yellow-700">
                            PayPal integration in progress. Please use M-Pesa.
                        </p>
                    </div>
                </div>

                <!-- Card Payment Fields -->
                <div id="cardFields" class="hidden">
                    <div class="bg-yellow-50 p-4 rounded-md border border-yellow-100">
                        <div class="flex items-center mb-2 text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="font-medium">Coming Soon</span>
                        </div>
                        <p class="text-sm text-yellow-700">
                            Card payments coming soon. Please use M-Pesa.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="document.getElementById('paymentForm').classList.add('hidden')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-900 text-white rounded-md hover:bg-blue-800 flex items-center">
                    <span>Pay Now</span>
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleFAQ(element) {
        const content = element.nextElementSibling;
        const icon = element.querySelector('i');
        
        // Toggle display
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.classList.add('transform', 'rotate-180');
        } else {
            content.classList.add('hidden');
            icon.classList.remove('transform', 'rotate-180');
        }
    }

    function selectTier(tier, amount) {
        // TEMPORARY: Show coming soon message instead of payment popup
        // TODO: When M-Pesa credentials are configured, uncomment the original code below and comment out this alert
        alert('Payment functionality is coming soon! We\'re currently configuring our payment system. Please check back later.');
        return;
        
        // ORIGINAL PAYMENT POPUP CODE - UNCOMMENT WHEN PAYMENT IS READY:
        // const paymentForm = document.getElementById('paymentForm');
        // const totalAmount = document.getElementById('totalAmount');
        // const planTypeInput = document.getElementById('planType');
        // const amountInput = document.getElementById('amount');
        // 
        // // Set form values
        // planTypeInput.value = tier;
        // amountInput.value = amount;
        // totalAmount.textContent = `KSh ${amount}`;
        // 
        // // Show payment form
        // paymentForm.classList.remove('hidden');
        // 
        // // Add slide-in animation class if needed
        // paymentForm.classList.add('transform', 'translate-x-0');
        // 
        // // Default to M-Pesa payment method
        // document.getElementById('paymentMethod').value = 'mpesa';
        // togglePaymentMethod('mpesa');
        // 
        // // Scroll to top of payment form
        // paymentForm.scrollTop = 0;
    }

    // Toggle between student and graduate tiers
    document.getElementById('studentToggle').addEventListener('click', function() {
        this.classList.add('bg-blue-900', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        document.getElementById('graduateToggle').classList.remove('bg-blue-900', 'text-white');
        document.getElementById('graduateToggle').classList.add('bg-gray-200', 'text-gray-700');
        document.getElementById('studentTiers').classList.remove('hidden');
        document.getElementById('graduateTiers').classList.add('hidden');
    });

    document.getElementById('graduateToggle').addEventListener('click', function() {
        this.classList.add('bg-blue-900', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        document.getElementById('studentToggle').classList.remove('bg-blue-900', 'text-white');
        document.getElementById('studentToggle').classList.add('bg-gray-200', 'text-gray-700');
        document.getElementById('graduateTiers').classList.remove('hidden');
        document.getElementById('studentTiers').classList.add('hidden');
    });

    function toggleMembershipType(type) {
        const studentTiers = document.getElementById('studentTiers');
        const graduateTiers = document.getElementById('graduateTiers');
        const studentTab = document.getElementById('studentTab');
        const graduateTab = document.getElementById('graduateTab');

        if (type === 'student') {
            studentTiers.classList.remove('hidden');
            graduateTiers.classList.add('hidden');
            studentTab.classList.add('bg-blue-900', 'text-white');
            studentTab.classList.remove('text-blue-900', 'bg-white');
            graduateTab.classList.remove('bg-blue-900', 'text-white');
            graduateTab.classList.add('text-blue-900', 'bg-white');
        } else {
            studentTiers.classList.add('hidden');
            graduateTiers.classList.remove('hidden');
            graduateTab.classList.add('bg-blue-900', 'text-white');
            graduateTab.classList.remove('text-blue-900', 'bg-white');
            studentTab.classList.remove('bg-blue-900', 'text-white');
            studentTab.classList.add('text-blue-900', 'bg-white');
        }
    }

    function togglePaymentMethod(method) {
        const mpesaFields = document.getElementById('mpesaFields');
        const paypalFields = document.getElementById('paypalFields');
        const cardFields = document.getElementById('cardFields');
        const mpesaTab = document.getElementById('mpesaTab');
        const paypalTab = document.getElementById('paypalTab');
        const cardTab = document.getElementById('cardTab');
        const paymentMethodInput = document.getElementById('paymentMethod');

        paymentMethodInput.value = method;

        // Hide all fields first
        mpesaFields.classList.add('hidden');
        paypalFields.classList.add('hidden');
        cardFields.classList.add('hidden');
        
        // Reset all tabs
        mpesaTab.classList.remove('bg-blue-900', 'text-white', 'border-blue-500');
        paypalTab.classList.remove('bg-blue-900', 'text-white', 'border-blue-500');
        cardTab.classList.remove('bg-blue-900', 'text-white', 'border-blue-500');
        
        // Show the selected fields and activate the tab
        if (method === 'mpesa') {
            mpesaFields.classList.remove('hidden');
            mpesaTab.classList.add('border-blue-500');
        } else if (method === 'paypal') {
            paypalFields.classList.remove('hidden');
            paypalTab.classList.add('border-blue-500');
        } else if (method === 'card') {
            cardFields.classList.remove('hidden');
            cardTab.classList.add('border-blue-500');
        }
    }

    // Initialize the payment method (default to M-Pesa)
    document.addEventListener('DOMContentLoaded', function() {
        togglePaymentMethod('mpesa');
        
        // Check if user should see payment popup (from registration workflow)
        const urlParams = new URLSearchParams(window.location.search);
        const showPayment = urlParams.get('show_payment');
        const fromRegistration = urlParams.get('from_registration');
        
        if (showPayment === 'true' && fromRegistration === 'true') {
            // Auto-select first year student plan and show payment popup
            setTimeout(() => {
                selectTier('first_year', 250);
            }, 500);
        }
        
        // Form submission handling
        document.getElementById('membershipForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const paymentMethod = formData.get('payment_method');
            
            if (paymentMethod === 'mpesa') {
                // Show loading indicator
                document.getElementById('paymentForm').classList.add('opacity-50');
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                
                // Handle M-Pesa payment
                fetch('/membership/process-mpesa/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<span>Pay Now</span><i class="fas fa-arrow-right ml-2"></i>';
                    document.getElementById('paymentForm').classList.remove('opacity-50');
                    
                    if (data.success) {
                        // Show payment confirmation dialog
                        document.getElementById('paymentConfirmation').classList.remove('hidden');
                        
                        // Start checking payment status
                        if (data.checkout_request_id) {
                            checkPaymentStatus(data.checkout_request_id, data.payment_id);
                        } else {
                            // No checkout request ID (possible in development mode)
                            console.warn('No checkout request ID provided');
                        }
                    } else {
                        alert(data.error || 'Payment processing failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<span>Pay Now</span><i class="fas fa-arrow-right ml-2"></i>';
                    document.getElementById('paymentForm').classList.remove('opacity-50');
                });
            } else {
                // Handle PayPal payment
                fetch('/membership/process-paypal/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert(data.error || 'Payment processing failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            }
        });
    });

    // Function to close payment dialog
    function closePaymentDialog() {
        document.getElementById('paymentConfirmation').classList.add('hidden');
    }
    
    // Function to confirm manual payment
    function confirmPayment() {
        const mpesaCode = document.getElementById('mpesaCode').value.trim();
        
        if (!mpesaCode) {
            alert('Please enter a valid M-Pesa transaction code');
            return;
        }
        
        // Show loading state
        const confirmButton = document.querySelector('#paymentConfirmation button:first-of-type');
        confirmButton.disabled = true;
        confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Confirming...';
        
        // Send to server for verification
        fetch('/membership/verify-mpesa-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                mpesa_code: mpesaCode,
                plan_type: document.getElementById('planType').value,
                amount: document.getElementById('amount').value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to success page with member number
                window.location.href = data.redirect_url;
            } else {
                alert(data.error || 'Payment verification failed. Please check the code and try again.');
                confirmButton.disabled = false;
                confirmButton.innerHTML = 'Confirm Payment';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            confirmButton.disabled = false;
            confirmButton.innerHTML = 'Confirm Payment';
        });
    }
    
    // Function to check payment status
    function checkPaymentStatus(checkoutRequestId, paymentId) {
        let attempts = 0;
        const maxAttempts = 10;
        const statusInterval = setInterval(() => {
            if (attempts >= maxAttempts) {
                clearInterval(statusInterval);
                document.getElementById('stkMessage').innerHTML = `
                    <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                        <p class="text-yellow-800">Payment status check timed out. If you completed the payment, please enter the M-Pesa code below.</p>
                    </div>
                `;
                return;
            }
            
            attempts++;
            
            fetch('/membership/check-payment-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    checkout_request_id: checkoutRequestId,
                    payment_id: paymentId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(statusInterval);
                    
                    // Payment was successful
                    if (data.status === 'completed') {
                        document.getElementById('stkMessage').innerHTML = `
                            <div class="bg-green-50 p-3 rounded border border-green-200">
                                <p class="text-green-800"><i class="fas fa-check-circle mr-2"></i> Payment successful!</p>
                                <p class="text-sm text-green-700 mt-2">Your ESA membership is now active.</p>
                                <p class="text-sm font-bold mt-2">Your Member Number: ${data.member_number || 'Generated'}</p>
                            </div>
                        `;
                        
                        // Redirect after 3 seconds
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 3000);
                    } else {
                        document.getElementById('stkMessage').innerHTML = `
                            <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                <p class="text-yellow-800">Payment is still processing. Please wait...</p>
                            </div>
                        `;
                    }
                } else if (data.status === 'failed') {
                    clearInterval(statusInterval);
                    document.getElementById('stkMessage').innerHTML = `
                        <div class="bg-red-50 p-3 rounded border border-red-200">
                            <p class="text-red-800"><i class="fas fa-times-circle mr-2"></i> Payment failed</p>
                            <p class="text-sm text-red-700 mt-2">${data.message || 'Please try again or use another payment method.'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
            });
        }, 5000); // Check every 5 seconds
    }
</script>
{% endblock %}
