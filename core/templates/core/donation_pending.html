{% extends 'core/base.html' %}
{% load static %}

{% block title %}Donation Pending - ESA-KU{% endblock %}

{% block content %}
<div class="bg-blue-900">
  <div class="max-w-7xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-extrabold text-white sm:text-4xl">
      Complete Your Donation
    </h1>
    <p class="mt-4 text-lg text-blue-100">
      Please check your phone to complete the M-Pesa payment
    </p>
  </div>
</div>

<div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
  <div class="bg-white rounded-lg shadow-lg p-8">
    <div class="mb-8 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
        <i class="fas fa-mobile-alt text-blue-600 text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Check Your Phone</h2>
      <p class="text-gray-600 max-w-md mx-auto">
        We've sent an M-Pesa payment request to your phone. Please enter your PIN to complete the transaction.
      </p>
    </div>
    
    <div class="mb-8 max-w-lg mx-auto bg-gray-50 p-6 rounded-lg border border-gray-200">
      <div class="flex justify-between items-center mb-4">
        <span class="text-gray-600">Amount:</span>
        <span class="font-bold text-green-700">KSh {{ payment.amount }}</span>
      </div>
      
      <div class="relative pt-1 mb-6">
        <div class="overflow-hidden h-2 text-xs flex rounded bg-blue-200">
          <div id="progress-bar" class="animate-pulse shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500" style="width: 75%"></div>
        </div>
      </div>
      
      <div class="text-center">
        <span id="payment-status" class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
          <svg class="w-4 h-4 mr-1.5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Waiting for payment confirmation...
        </span>
      </div>
    </div>
    
    <div class="max-w-lg mx-auto">
      <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-yellow-700">
              Please don't close this page until your payment is confirmed.
            </p>
          </div>
        </div>
      </div>
      
      <div class="space-y-4">
        <button id="check-status-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition">
          Check Payment Status
        </button>
        
        <div class="text-center">
          <a href="{% url 'donation_success' %}?payment_id={{ payment.id }}" class="text-blue-600 hover:underline text-sm">
            I've already completed the payment
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkStatusBtn = document.getElementById('check-status-btn');
    const paymentStatus = document.getElementById('payment-status');
    const progressBar = document.getElementById('progress-bar');
    
    let checkCount = 0;
    
    // Function to check payment status
    function checkStatus() {
      checkCount++;
      
      // Show checking status
      checkStatusBtn.disabled = true;
      checkStatusBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2 inline-block animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Checking...
      `;
      
      // Simulate API call to check payment status
      setTimeout(function() {
        checkStatusBtn.disabled = false;
        checkStatusBtn.innerHTML = 'Check Payment Status';
        
        // For demo purposes:
        // After 3 checks, show success
        if (checkCount >= 3) {
          // Redirect to success page
          window.location.href = "{% url 'donation_success' %}?payment_id={{ payment.id }}";
        } else {
          // Show still pending
          paymentStatus.innerHTML = `
            <svg class="w-4 h-4 mr-1.5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Still waiting for confirmation...
          `;
        }
      }, 2000);
    }
    
    // Attach event listener
    if (checkStatusBtn) {
      checkStatusBtn.addEventListener('click', checkStatus);
    }
    
    // Auto-check status every 10 seconds
    const autoCheckInterval = setInterval(function() {
      if (checkCount >= 3) {
        clearInterval(autoCheckInterval);
      } else {
        checkStatus();
      }
    }, 10000);
  });
</script>
{% endblock %}
