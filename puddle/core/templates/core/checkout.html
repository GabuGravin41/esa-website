{% extends 'core/base.html' %}
{% load static %}

{% block title %}Checkout - ESA Store{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="bg-gray-100 py-4">
  <div class="container mx-auto px-4">
    <div class="flex items-center text-sm">
      <a href="{% url 'home' %}" class="text-blue-900 hover:underline">Home</a>
      <span class="mx-2">/</span>
      <a href="{% url 'store' %}" class="text-blue-900 hover:underline">Store</a>
      <span class="mx-2">/</span>
      <a href="{% url 'cart' %}" class="text-blue-900 hover:underline">Cart</a>
      <span class="mx-2">/</span>
      <span class="text-gray-600">Checkout</span>
    </div>
  </div>
</div>

<!-- Checkout Content -->
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-blue-900 mb-8">Checkout</h1>
  
  {% if cart_items %}
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Checkout Form -->
      <div class="w-full lg:w-2/3">
        <form method="post" action="{% url 'checkout' %}" class="space-y-8">
          {% csrf_token %}
          
          <!-- Shipping Information -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-blue-900 mb-4">Shipping Information</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                <input type="text" id="first_name" name="first_name" class="w-full p-2 border border-gray-300 rounded-md" required>
              </div>
              
              <div>
                <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                <input type="text" id="last_name" name="last_name" class="w-full p-2 border border-gray-300 rounded-md" required>
              </div>
              
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                <input type="email" id="email" name="email" class="w-full p-2 border border-gray-300 rounded-md" required>
              </div>
              
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input type="tel" id="phone" name="phone" class="w-full p-2 border border-gray-300 rounded-md" required>
              </div>
              
              <div class="md:col-span-2">
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                <input type="text" id="address" name="address" class="w-full p-2 border border-gray-300 rounded-md" required>
              </div>
              
              <div>
                <label for="delivery_method" class="block text-sm font-medium text-gray-700 mb-1">Delivery Method</label>
                <select id="delivery_method" name="delivery_method" class="w-full p-2 border border-gray-300 rounded-md">
                  <option value="pickup">Pickup at ESA Office</option>
                  <option value="delivery">Delivery to Address</option>
                </select>
              </div>
              
              <div>
                <label for="student_id" class="block text-sm font-medium text-gray-700 mb-1">Student ID (Optional)</label>
                <input type="text" id="student_id" name="student_id" class="w-full p-2 border border-gray-300 rounded-md">
              </div>
            </div>
          </div>
          
          <!-- Payment Method -->
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-blue-900 mb-4">Payment Method</h2>
            
            <div class="space-y-4">
              <div class="flex items-center">
                <input type="radio" id="mpesa" name="payment_method" value="mpesa" class="mr-2" checked>
                <label for="mpesa" class="text-gray-700">M-Pesa</label>
              </div>
              
              <div class="flex items-center">
                <input type="radio" id="card" name="payment_method" value="card" class="mr-2">
                <label for="card" class="text-gray-700">Credit/Debit Card</label>
              </div>
              
              <div class="flex items-center">
                <input type="radio" id="paypal" name="payment_method" value="paypal" class="mr-2">
                <label for="paypal" class="text-gray-700">PayPal</label>
              </div>
              
              <div class="payment-details mpesa-details">
                <label for="mpesa_phone" class="block text-sm font-medium text-gray-700 mb-1">M-Pesa Phone Number</label>
                <input type="tel" id="mpesa_phone" name="mpesa_phone" placeholder="e.g. 254712345678" class="w-full p-2 border border-gray-300 rounded-md">
                <p class="text-sm text-gray-500 mt-1">You will receive an STK push to this number to complete the payment.</p>
              </div>
              
              <div class="payment-details card-details hidden">
                <!-- Card payment fields would go here -->
                <p class="text-sm text-gray-500">Card payment integration coming soon.</p>
              </div>
              
              <div class="payment-details paypal-details hidden">
                <!-- PayPal payment info would go here -->
                <p class="text-sm text-gray-500">You will be redirected to PayPal to complete your payment.</p>
              </div>
            </div>
          </div>
          
          <div class="flex justify-between items-center">
            <a href="{% url 'cart' %}" class="flex items-center text-blue-900 hover:underline">
              <i class="fas fa-arrow-left mr-2"></i> Back to Cart
            </a>
            
            <button type="submit" class="bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg font-bold transition">
              Complete Order
            </button>
          </div>
        </form>
      </div>
      
      <!-- Order Summary -->
      <div class="w-full lg:w-1/3">
        <div class="bg-white rounded-lg shadow p-6 sticky top-8">
          <h2 class="text-xl font-bold text-blue-900 mb-6">Order Summary</h2>
          
          <div class="max-h-64 overflow-y-auto mb-6">
            {% for item in cart_items %}
              <div class="flex items-center py-3 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                <div class="flex-shrink-0 h-16 w-16 mr-4">
                  {% if item.product.image %}
                    <img class="h-16 w-16 object-cover rounded" src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                  {% else %}
                    <div class="h-16 w-16 bg-gray-200 flex items-center justify-center rounded">
                      <i class="fas fa-shopping-bag text-gray-400"></i>
                    </div>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <h3 class="text-sm font-medium text-gray-900">{{ item.product.name }}</h3>
                  <p class="text-sm text-gray-500">Qty: {{ item.quantity }}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm font-medium text-gray-900">KSh {{ item.item_total }}</p>
                </div>
              </div>
            {% endfor %}
          </div>
          
          <div class="space-y-4 mb-6">
            <div class="flex justify-between border-b pb-4">
              <span class="text-gray-600">Subtotal ({{ item_count }} items)</span>
              <span class="font-bold">KSh {{ total }}</span>
            </div>
            <div class="flex justify-between border-b pb-4">
              <span class="text-gray-600">Shipping</span>
              <span>Free</span>
            </div>
            <div class="flex justify-between text-lg">
              <span class="font-bold">Total</span>
              <span class="font-bold text-green-700">KSh {{ total }}</span>
            </div>
          </div>
          
          <div class="text-sm text-gray-600 border-t pt-4">
            <p>By completing your purchase, you agree to our <a href="#" class="text-blue-900 hover:underline">Terms of Service</a> and <a href="#" class="text-blue-900 hover:underline">Privacy Policy</a>.</p>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="bg-white rounded-lg shadow p-8 text-center">
      <div class="mb-6">
        <i class="fas fa-shopping-cart text-gray-300 text-7xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-700 mb-4">Your cart is empty</h2>
      <p class="text-gray-600 mb-6">You need to add items to your cart before checking out.</p>
      <a href="{% url 'store' %}" class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-3 rounded-lg inline-block transition">
        Go to Store
      </a>
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const paymentDetails = document.querySelectorAll('.payment-details');
    
    function showSelectedPaymentDetails() {
      const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
      
      paymentDetails.forEach(detail => {
        detail.classList.add('hidden');
      });
      
      document.querySelector(`.${selectedMethod}-details`).classList.remove('hidden');
    }
    
    paymentRadios.forEach(radio => {
      radio.addEventListener('change', showSelectedPaymentDetails);
    });
    
    // Show the initially selected payment method details
    showSelectedPaymentDetails();
  });
</script>
{% endblock %} 